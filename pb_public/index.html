<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Chat.Startr.Space an example app to get you started with Pocketbase and chat" />
    <meta name="author" content="Startr.Space" />
    <meta name="keywords" content="Startr.Space, Chat, Pocketbase, Example, App, Startr.Style, Startr, Space" />
    <meta name="robots" content="index, follow" />

    <title>Startr Chat</title>

    <script src="js/pocketbase.umd.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <link rel="stylesheet" href="https://startr.style/style.css" />
  </head>
  <body style="--d: flex; --fd: column">
    <div x-data="friends">
      <nav>
        <ul style="--lis: none; --p: 0">
          <li>
            <h1 @click="selectedFriend = null" style="--m: 0; --ta: center; --cur: pointer">Startr Chat</h1>
          </li>
          <li x-show="!showLogin" @click="logout()" style="--cur: pointer; --ta: right">Logout</li>
        </ul>
      </nav>

      <!-- login / signup -->
      <form onsubmit="return false;" x-show="showLogin" x-transition>
        <h2>Login</h2>
        <label for="email">Email</label>
        <input x-model="email" type="email" id="email" placeholder="Email address" />

        <label for="password">Password</label>
        <input x-model="password" type="password" id="password" autocomplete=""current-password"" />

        <button @click="login()">Login</button>
        <mark x-show="loginMessage" x-text="loginMessage"></mark>
        <hr style="--m: 4rem" />
      </form>
      <form onsubmit="return false;" x-show="showLogin" x-transition>
        <h2>Signup</h2>
        <label for="email">Email</label>
        <input x-model="email" type="email" id="email" placeholder="Email address" autocomplete="email" />

        <label for="password">Password</label>
        <input x-model="password" type="password" id="password" autocomplete="new-password" />

        <label for="passwordConfirm">Confirm Password</label>
        <input x-model="passwordConfirm" type="password" id="passwordConfirm" autocomplete="new-password" />

        <button @click="signup()">Signup</button>
        <mark x-show="signupMessage" x-text="signupMessage"></mark>
      </form>

      <!-- show friends -->
      <form onsubmit="return false;" x-show="!showLogin && !selectedFriend" x-transition style="--mt: 10%">
        <h2>Your Friends</h2>

        <template x-for="friend in friends">
          <div style="--d: flex; --jc: space-between; --mt: 1rem">
            <u><strong x-text="friend.username" @click="selectFriend(friend)" style="--cur: pointer"></strong></u>
            <a @click="deleteFriend(friend)" style="--ta: end; --cur: pointer">â˜’</a>
          </div>
        </template>

        <input style="--mt:0.6rem" @keyup="findFriend" x-model="newFriendName" id="newFriend" type="newFriend" placeholder="Search for friends" />
      </form>

      <!-- show selectedFriend messages -->
      <form onsubmit="return false;" x-show="!showLogin && selectedFriend" x-transition style="--mt: 10%">
        <template x-if="selectedFriend">
          <h2>Messages with <i x-text="selectedFriend.username"></i></h2>
        </template>

        <template x-for="message in messages">
          <div style="--d:flex; --ai: center">
            <i style="--d: flex; --w: 40px; --h: 40px; --br: 50%; --bg: rgb(0, 157, 255); --m: 0.3rem; --size:10px; --ai: center; --jc:center"  x-text="message.expand.senderID.username">
              </i
            >
            <strong x-text="message.text"></strong>
          </div>
        </template>

        <div style="--d:flex">
        <label for="newMessage"></label>
        <input x-model="newMessage" id="newMessage" type="newMessage" placeholder="Message" />
        <button @click="sendMessage">Send</button>

        <hr style="--m: 1rem" />
        </div>
        <button @click="selectedFriend = null">Back</button>
      </form>
    </div>
    <script>
      var test_var = "test";

      document.addEventListener("alpine:init", () => {
        Alpine.data("friends", () => ({
          // pocketbase client
          client: null,

          // login / signup
          showLogin: false,
          email: null,
          password: null,
          passwordConfirm: null,
          loginMessage: null,
          signupMessage: null,

          // friends data
          friends: [],
          newFriendName: "",
          selectedFriend: null,

          // messages data
          messages: null,
          newMessage: null,

          async init() {
            // initialize pocketbase
            this.client = new PocketBase("http://192.168.87.125:8090");

            // capture invalid token
            this.client.afterSend = (response, data) => {
              if (response.status === 401) {
                this.showLogin = true;
              }

              return data;
            };

            // if user is not logged in, show login / signup page
            if (!window.localStorage.getItem("pocketbase_auth")) {
              this.showLogin = true;
              return;
            }

            // resume session
            const auth = JSON.parse(window.localStorage.getItem("pocketbase_auth"));
            this.client.authStore.save(auth.token, auth.model);

            // fetch friends
            this.getFriends();

            // suscribe to live update events
            //this.subscribeToFriends();
          },

          // login
          async login() {
            try {
              const user = await this.client.collection("users").authWithPassword(this.email, this.password);
              this.getFriends();
              //this.subscribeToFriends();
              this.showLogin = false;
              this.email = "";
              this.password = "";
            } catch (err) {
              this.loginMessage = err.data.message;
            }
          },

          // signup
          async signup() {
            try {
              const user = await this.client.collection("users").create({
                username: this.email
                  .split("@")[0] // Remove the domain
                  .replace(/\./g, "_") // Replace all dots with underscores
                  .split("_") // Split by underscores
                  .map((part) => part.charAt(0).toUpperCase() + part.slice(1).toLowerCase()) // Capitalize each part
                  .join("_"),
                email: this.email,
                password: this.password,
                passwordConfirm: this.passwordConfirm,
              });
              this.email = "";
              this.password = "";
              this.passwordConfirm = "";
              this.signupMessage = "Success! Please, login.";
            } catch (err) {
              console.log(err);
              this.signupMessage = err.data.message;
              if (err.data.data.email) this.signupMessage += ` Email: ${err.data.data.email.message}`;
              if (err.data.data.password) this.signupMessage += ` Password: ${err.data.data.password.message}`;
              if (err.data.data.passwordConfirm)
                this.signupMessage += ` Password Confirm: ${err.data.data.passwordConfirm.message}`;
            }
          },

          // logout
          async logout() {
            this.client.authStore.clear();
            this.showLogin = true;
          },

          // get friends
          async getFriends() {
            console.log("Getting friends...");
            const friends = await this.client.collection("users").getFullList({
              sort: "-created",
            });
            this.friends = friends;
          },

          async findFriend() {
            try {
              console.log("Finding friend...");
              console.log(this.newFriendName);
              const filter = `username~${this.newFriendName}`;

              console.log("Trying with filter: username~" + this.newFriendName);
              const friends = await this.client.collection("users").getList(1, 50, {
                filter: `username~'${this.newFriendName}'`,
              });
              this.friends = friends.items;
            } catch (err) {
              console.log("ERR", err);
            }
          },

          async deleteFriend(friend) {
            try {
              await this.client.records.delete("friend", friend.id);
            } catch (err) {
              console.log("ERR", err);
            }
          },

          async selectFriend(friend) {
            try {
              messages = await this.client.collection("messages").getList(1, 50, {
                filter: `recipientID = '${friend.id}' || senderID = '${friend.id}'`,
                expand: "senderID, recipientID",
              });
              this.selectedFriend = friend;
              this.messages = messages.items;
              console.log("Messages", this.messages);
            } catch (err) {
              console.log("ERR", err);
            }
          },

          // messages functions
          async sendMessage() {
            try {
              await this.client.records.create("message", { text: this.newMessage, friend: this.selectedFriend.id });
              this.newMessage = "";
            } catch (err) {
              console.log("ERR", err);
            }
          },

          async deleteMessage(message) {
            try {
              await this.client.records.delete("message", message.id);
            } catch (err) {
              console.log("ERR", err);
            }
          },

          async toggleDone(message, toggle) {
            try {
              await this.client.records.update("message", message.id, { done: toggle });
            } catch (err) {
              console.log("ERR", err);
            }
          },
        }));
      });

      function firstLetterToColor(str) {
        if (!str) return '#000000'; // Return black if the string is empty or undefined
    
        const lowerCaseStr = str.toLowerCase(); // Convert string to lowercase to handle case insensitivity
        const firstChar = lowerCaseStr.charCodeAt(0); // Get char code of the first character
        if (firstChar < 97 || firstChar > 122) return '#000000'; // Return black if it's not a letter
    
        const hue = ((firstChar - 97) / 26) * 360; // Scale the character position to 360 degrees
        return `hsl(${hue}, 100%, 50%)`; // Return the HSL color string
    }
    </script>
    <style>
      input::placeholder{
        color:hsl(207.37, 85.07%, 78.86%) !important 
      }
    </style>
  </body>
</html>
